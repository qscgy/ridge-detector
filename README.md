# MIDAG ridge detector
By Sam Ehrenstein \<ehrensam@cs.unc.edu>

Parts are adapted from https://gihub.com/meng-tang/rloss.

## Requirements
These are the libraries and versions used to develop and test this software. All of these were installed into a conda environment using pip except for pytorch and torchvision, which I installed from the pytorch Anaconda channel; and numpy, which I installed with `conda install numpy`. My Python version is 3.9.12, but my code should work with any Python >= 3.9.

```
numpy==1.22.3
scipy==1.7.3
matplotlib==3.5.2
pytorch==1.12.0
torchvision==0.13.0
tensorboard==2.9.1
pillow==9.0.1
tqdm==4.64.0
opencv==4.6.0.66
pandas==1.4.3
scikit-learn==1.1.1
scikit-image==0.19.3
natsort==8.1.0
pyyaml==6.0
```

## Directory structure
There are two separate directories you will need. The first is the sequence directory, which contains all colonoscopy sequences and the ColDE outputs (each in a separate directory). This is assigned to the variable `sequence_dir` in `scribble.py`. Using the ColDE model `colon_norm_preall_abs_nosm`, mine looks like this:
```
/playpen/Datasets/geodepth2
├── 000
│   ├── colon_norm_preall_abs_nosm
│   │   ├── frame031194_disp.jpeg
│   │   ├── frame031194_disp.npy
│   │   ├── frame031195_disp.jpeg
│   │   ├── frame031195_disp.npy
│   │   ├── frame031195_pose.npy
│   │   ├── frame031196_disp.jpeg
│   │   ├── frame031196_disp.npy
│   │   ├── frame031196_pose.npy
        ...
│   ├── image
│   │   ├── frame031194.jpg
│   │   ├── frame031195.jpg
│   │   ├── frame031196.jpg
        ...
│   ├── img_corr
│   │   ├── frame031194.jpg
│   │   ├── frame031195.jpg
│   │   ├── frame031196.jpg
        ...
├── 001
│   ├── colon_norm_preall_abs_nosm
│   ├── image
│   ├── img_corr
...
```

The second directory is the annotation directory, passed as the `--base-dir` command-line argument, which contains three files. `annotations.pkl` is the training annotation file, generated by `scribble.py`. `annotations_test.pkl` is the test annotation file, also generated by `scribble,py`. `test_set.pkl` contains a list of the test images. `annotations_test.pkl` is only needed if using ground truth. Ensure that the `--gt` flag is set correctly.

## Scribble annotations
The scribble annotator is in `scribble.py`. To run, execute `python scribble.py` after setting the `sequence_dir` variable at the top to be the sequence directory described above.
### Controls
Left-click and drag to draw annotations. The following keys are used:
| **Key** | **function**                                       |
|---------|----------------------------------------------------|
| D       | next image                                         |
| A       | previous image                                     |
| M       | switch between drawing fold and not-fold scribbles |
| R       | Remove the last scribble                           |
| Esc     | Save and exit                                      |

The annotations will be saved into the file location given by the `dump_file` variable. By default, it is `annotations.pkl` in the current working directory.

## Training
To train, run `sh trainscribble.py` and set the command-line arguments accordingly.

## Testing
To test, run `sh inferscribble.py` and set the command-line arguments accordingly. `foldit-dir` is the path to the FoldIt outputs, which I will provide.